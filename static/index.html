<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Agent Pro - Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #0f1419;
            --bg-tertiary: #141922;
            --surface: #1a1f2e;
            --surface-hover: #222838;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2d3748;
            --glow: rgba(59, 130, 246, 0.4);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: var(--border); 
            border-radius: 10px; 
            border: 2px solid var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .app-container {
            display: grid;
            grid-template-columns: 320px 1fr 360px;
            gap: 0;
            width: 100%;
            height: 100vh;
        }

        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 24px 20px;
            background: var(--accent-gradient);
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .sidebar-tabs {
            display: flex;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-muted);
        }

        .sidebar-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .sidebar-tab:hover {
            background: var(--surface-hover);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .card.collapsible .card-header {
            cursor: pointer;
            user-select: none;
        }

        .card.collapsed .card-body {
            display: none;
        }

        .card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-icon {
            font-size: 18px;
        }

        .collapse-icon {
            font-size: 12px;
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }

        .card.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
            color: #000;
        }

        .btn-error {
            background: var(--error);
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 11px;
        }

        .btn-block {
            width: 100%;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle.active {
            background: var(--accent-primary);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle.active::after {
            left: 22px;
        }

        .toggle-label {
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .main-header {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-header-left, .main-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .quick-stats {
            display: flex;
            gap: 12px;
            padding: 12px 24px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .quick-stat {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .quick-stat-icon {
            font-size: 20px;
        }

        .quick-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .quick-stat-value {
            font-size: 16px;
            font-weight: 700;
        }

        .history-panel {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .history-panel.active {
            display: block;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.3s;
        }

        .history-item:hover {
            background: var(--surface-hover);
        }

        .history-thumbnail {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .history-step {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .history-thought {
            font-size: 11px;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .live-monitor {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .monitor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .monitor-toolbar-left, .monitor-toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monitor-stats {
            padding: 12px 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .monitor-viewport {
            position: relative;
            background: #000;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .monitor-viewport img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .monitor-viewport.zoomed {
            overflow: auto;
        }

        .monitor-viewport.zoomed img {
            max-width: none;
            max-height: none;
            width: 200%;
            cursor: zoom-out;
        }

        .agent-status-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: 700;
            color: var(--accent-primary);
            text-shadow: 0 0 30px var(--glow);
            animation: fadeInOut 2s infinite;
            pointer-events: none;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .screenshot-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .monitor-viewport:hover .screenshot-controls {
            opacity: 1;
        }

        .screenshot-btn {
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .screenshot-btn:hover {
            background: var(--accent-primary);
        }

        .control-panel {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 6px;
            margin-bottom: 12px;
        }

        .pause-control-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .pause-control-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .vertical-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
        }

        .message-box {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .message-ticker {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 12px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ticker-icon {
            font-size: 16px;
        }

        .ticker-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .speed-control {
            margin: 12px 0;
        }

        .speed-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }

        .speed-label-item {
            font-size: 9px;
            color: var(--text-muted);
        }

        .task-queue {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .task-current {
            background: var(--accent-gradient);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .task-current h4 {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .task-current-text {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.4;
        }

        .task-groups-section {
            margin-bottom: 16px;
        }

        .task-groups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .task-groups-header h4 {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .task-group-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-group-item:hover {
            background: var(--surface-hover);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .task-group-name {
            font-size: 13px;
            font-weight: 500;
        }

        .task-group-count {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .task-group-actions {
            display: flex;
            gap: 4px;
        }

        .task-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .task-list-header h4 {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .task-list {
            flex: 1;
            overflow-y: auto;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            min-height: 200px;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-item:hover {
            background: var(--surface-hover);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .task-item.active {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.has-subtasks {
            flex-direction: column;
        }

        .task-main-row {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .task-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-text {
            font-size: 13px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .task-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .subtasks-container {
            margin-top: 12px;
            padding-left: 32px;
            width: 100%;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .subtask-icon {
            font-size: 14px;
        }

        .subtask-text {
            flex: 1;
            color: var(--text-secondary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .modal-content {
            margin-bottom: 24px;
        }

        .modal-info {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .modal-info-item {
            margin-bottom: 12px;
        }

        .modal-info-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .modal-info-value {
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .preset-item {
            padding: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .preset-item:hover {
            background: var(--surface-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .preset-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .preset-name {
            font-size: 12px;
            font-weight: 600;
        }

        .log-viewer {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .log-entry {
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            display: flex;
            gap: 8px;
        }

        .log-entry.info { background: rgba(59, 130, 246, 0.1); }
        .log-entry.success { background: rgba(16, 185, 129, 0.1); }
        .log-entry.warning { background: rgba(245, 158, 11, 0.1); }
        .log-entry.error { background: rgba(239, 68, 68, 0.1); }

        .log-time {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .log-message {
            flex: 1;
            color: var(--text-secondary);
        }

        .shortcuts-panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .shortcut-item:last-child {
            border-bottom: none;
        }

        .shortcut-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        .shortcut-key {
            padding: 4px 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-primary);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .badge-error { background: rgba(239, 68, 68, 0.15); color: var(--error); }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--accent-primary); }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2563eb;
            transform: scale(1.2);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9); }
            70% { transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 280px 1fr 320px;
            }
        }

        @media (max-width: 992px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            .sidebar, .task-queue {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Modals -->
    <div id="confirmationOverlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>ü§ñ Action Confirmation</h2>
                <p>Review the agent's next planned action</p>
            </div>
            <div class="modal-content">
                <div class="modal-info">
                    <div class="modal-info-item">
                        <div class="modal-info-label">Intelligence Gathered</div>
                        <div id="dialogIntel" class="modal-info-value"></div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Next Action</div>
                        <div id="dialogNextTask" class="modal-info-value"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Custom Task Override (Optional)</label>
                    <input type="text" id="customTaskInput" placeholder="Enter custom instruction..." />
                </div>
            </div>
            <div class="modal-actions">
                <button id="confirmYesBtn" class="btn btn-success btn-block">‚úì Approve</button>
                <button id="confirmNoBtn" class="btn btn-error btn-block">‚úó Reject</button>
            </div>
        </div>
    </div>

    <div id="saveGroupOverlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>üíæ Save Task Group</h2>
                <p>Save current tasks as a reusable group</p>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label>Group Name</label>
                    <input type="text" id="groupNameInput" placeholder="e.g., Research Workflow" />
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="groupDescInput" style="min-height: 60px;" placeholder="Brief description..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button id="saveGroupBtn" class="btn btn-success btn-block">üíæ Save Group</button>
                <button id="cancelGroupBtn" class="btn btn-secondary btn-block">Cancel</button>
            </div>
        </div>
    </div>

    <div id="presetsOverlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>‚ö° Quick Start Templates</h2>
                <p>Select a preset configuration</p>
            </div>
            <div class="modal-content">
                <div class="preset-grid">
                    <div class="preset-item" onclick="loadPreset('research')">
                        <div class="preset-icon">üîç</div>
                        <div class="preset-name">Deep Research</div>
                    </div>
                    <div class="preset-item" onclick="loadPreset('testing')">
                        <div class="preset-icon">üß™</div>
                        <div class="preset-name">Web Testing</div>
                    </div>
                    <div class="preset-item" onclick="loadPreset('scraping')">
                        <div class="preset-icon">üìä</div>
                        <div class="preset-name">Data Scraping</div>
                    </div>
                    <div class="preset-item" onclick="loadPreset('automation')">
                        <div class="preset-icon">‚öôÔ∏è</div>
                        <div class="preset-name">Task Automation</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="closePresetsModal()" class="btn btn-secondary btn-block">Close</button>
            </div>
        </div>
    </div>

    <div id="shortcutsOverlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
                <p>Boost your productivity</p>
            </div>
            <div class="modal-content">
                <div class="shortcuts-panel">
                    <div class="shortcut-item">
                        <div class="shortcut-desc">Run current task</div>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">Ctrl</span>
                            <span class="shortcut-key">Enter</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-desc">Stop agent</div>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">Ctrl</span>
                            <span class="shortcut-key">S</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-desc">Pause next step</div>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">Ctrl</span>
                            <span class="shortcut-key">P</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-desc">Add new task</div>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">Ctrl</span>
                            <span class="shortcut-key">N</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-desc">Toggle history</div>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">Ctrl</span>
                            <span class="shortcut-key">H</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-desc">Show shortcuts</div>
                        <div class="shortcut-keys">
                            <span class="shortcut-key">?</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="closeShortcutsModal()" class="btn btn-secondary btn-block">Close</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><span>ü§ñ</span> Agent Control</h1>
                <p>Advanced Configuration</p>
            </div>

            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchSidebarTab('config')">‚öôÔ∏è Config</div>
                <div class="sidebar-tab" onclick="switchSidebarTab('logs')">üìù Logs</div>
                <div class="sidebar-tab" onclick="switchSidebarTab('help')">‚ùì Help</div>
            </div>

            <div class="sidebar-content">
                <div id="configTab" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <span class="card-icon">‚ö°</span>
                                <h3>Quick Actions</h3>
                            </div>
                        </div>
                        <div class="card-body">
                            <button onclick="showPresetsModal()" class="btn btn-block" style="margin-bottom: 8px;">üéØ Load Preset</button>
                            <button onclick="exportConfig()" class="btn btn-secondary btn-block" style="margin-bottom: 8px;">üíæ Export Config</button>
                            <button onclick="importConfig()" class="btn btn-secondary btn-block">üì• Import Config</button>
                        </div>
                    </div>

                    <div class="card collapsible">
                        <div class="card-header" onclick="toggleCard(this)">
                            <div class="card-header-left">
                                <span class="card-icon">‚öôÔ∏è</span>
                                <h3>Agent Setup</h3>
                            </div>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Agent Type</label>
                                <select id="agentType">
                                    <option value="browser">üåê Browser Agent</option>
                                    <option value="deep_research">üîç Deep Research</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Extraction Model</label>
                                <select id="extractionModel">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Resume Task ID</label>
                                <input type="text" id="resumeTaskId" placeholder="Optional UUID" />
                            </div>
                        </div>
                    </div>

                    <div class="card collapsible">
                        <div class="card-header" onclick="toggleCard(this)">
                            <div class="card-header-left">
                                <span class="card-icon">üß†</span>
                                <h3>LLM Provider</h3>
                            </div>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Provider</label>
                                <select id="llmProvider" onchange="updateLLMSettings()">
                                    <option value="openai">OpenAI</option>
                                    <option value="gemini">Gemini</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="ollama">Ollama</option>
                                </select>
                            </div>
                            <div id="apiKeyField" class="form-group">
                                <label>API Key</label>
                                <input type="password" id="apiKey" placeholder="sk-..." />
                            </div>
                            <div class="form-group">
                                <label>Model Name</label>
                                <input type="text" id="modelName" placeholder="Model name" />
                            </div>
                            <div class="form-group">
                                <label>Temperature: <span id="tempValue">0.0</span></label>
                                <input type="range" id="tempSlider" min="0" max="20" value="0" step="1" oninput="updateTemp(this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="card collapsible">
                        <div class="card-header" onclick="toggleCard(this)">
                            <div class="card-header-left">
                                <span class="card-icon">üéØ</span>
                                <h3>Behavior</h3>
                            </div>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="card-body">
                            <div class="toggle-group">
                                <div id="visionToggle" class="toggle active" onclick="toggleVision()"></div>
                                <label class="toggle-label" onclick="toggleVision()">Use Vision</label>
                            </div>
                            <div class="toggle-group">
                                <div id="soundToggle" class="toggle" onclick="toggleSound()"></div>
                                <label class="toggle-label" onclick="toggleSound()">Sound Notifications</label>
                            </div>
                            <div class="form-group">
                                <label>Max Steps</label>
                                <input type="number" id="maxSteps" value="500" />
                            </div>
                        </div>
                    </div>

                    <div class="card collapsible collapsed">
                        <div class="card-header" onclick="toggleCard(this)">
                            <div class="card-header-left">
                                <span class="card-icon">üîß</span>
                                <h3>Advanced JSON</h3>
                            </div>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="card-body">
                            <textarea id="settingsJson">{
  "llm": {
    "provider": "gemini",
    "model_name": "gemini-flash-latest",
    "temperature": 0.0
  },
  "agent": {
    "max_steps": 500,
    "use_vision": true
  }
}</textarea>
                        </div>
                    </div>
                </div>

                <div id="logsTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <span class="card-icon">üìù</span>
                                <h3>Activity Log</h3>
                            </div>
                            <button onclick="clearLogs()" class="btn btn-xs btn-error">Clear</button>
                        </div>
                        <div class="card-body">
                            <div id="logViewer" class="log-viewer"></div>
                        </div>
                    </div>
                </div>

                <div id="helpTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-left">
                                <span class="card-icon">‚ùì</span>
                                <h3>Quick Guide</h3>
                            </div>
                        </div>
                        <div class="card-body">
                            <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px;">
                                Welcome to Browser Agent Pro! Automate web tasks using AI.
                            </p>
                            <button onclick="showShortcutsModal()" class="btn btn-block" style="margin-bottom: 8px;">‚å®Ô∏è Shortcuts</button>
                            <button onclick="showPresetsModal()" class="btn btn-secondary btn-block">‚ö° Templates</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="main-header-left">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span id="agentStatusText">Ready</span>
                    </div>
                    <button onclick="toggleHistory()" class="btn btn-sm btn-secondary">üìú History</button>
                </div>
                <div class="main-header-right">
                    <button onclick="showShortcutsModal()" class="btn btn-sm btn-secondary">‚å®Ô∏è</button>
                    <span class="badge badge-info">v2.5</span>
                    <span id="stepCounter" class="badge badge-success">0 Steps</span>
                </div>
            </header>

            <div class="quick-stats">
                <div class="quick-stat">
                    <span class="quick-stat-icon">‚è±Ô∏è</span>
                    <div>
                        <div class="quick-stat-label">Runtime</div>
                        <div class="quick-stat-value" id="runtimeValue">00:00</div>
                    </div>
                </div>
                <div class="quick-stat">
                    <span class="quick-stat-icon">üéØ</span>
                    <div>
                        <div class="quick-stat-label">Success</div>
                        <div class="quick-stat-value" id="successRate">100%</div>
                    </div>
                </div>
                <div class="quick-stat">
                    <span class="quick-stat-icon">‚ö°</span>
                    <div>
                        <div class="quick-stat-label">Actions/Min</div>
                        <div class="quick-stat-value" id="actionsPerMin">0</div>
                    </div>
                </div>
                <div class="quick-stat">
                    <span class="quick-stat-icon">üíæ</span>
                    <div>
                        <div class="quick-stat-label">Memory</div>
                        <div class="quick-stat-value" id="memoryUsage">0 KB</div>
                    </div>
                </div>
            </div>

            <div id="historyPanel" class="history-panel"></div>

            <div class="live-monitor">
                <div class="monitor-toolbar">
                    <div class="monitor-toolbar-left">
                        <span style="color: var(--error);">‚óè</span>
                        <span style="font-size: 12px; font-weight: 600;">LIVE VIEW</span>
                    </div>
                    <div class="monitor-toolbar-right">
                        <button onclick="takeScreenshot()" class="btn btn-xs btn-secondary">üì∑</button>
                        <button onclick="toggleZoom()" class="btn btn-xs btn-secondary">üîç</button>
                    </div>
                </div>
                <div class="monitor-stats">
                    <div class="stat-item">
                        <div class="stat-label">State</div>
                        <div id="monitorState" class="stat-value">IDLE</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Goal</div>
                        <div id="monitorGoal" class="stat-value">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Data</div>
                        <div id="monitorData" class="stat-value">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">URL</div>
                        <div id="monitorUrl" class="stat-value">-</div>
                    </div>
                </div>
                <div id="monitorViewport" class="monitor-viewport">
                    <img id="liveImg" />
                    <div id="agentStatusDisplay" class="agent-status-overlay"></div>
                    <div class="screenshot-controls">
                        <button class="screenshot-btn" onclick="takeScreenshot()">üì∑ Save</button>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <div class="control-grid">
                    <button onclick="sendControl('force_review')" class="btn btn-sm">üëÅÔ∏è Review</button>
                    <button onclick="sendControl('force_participate')" class="btn btn-sm">‚úçÔ∏è Participate</button>
                    <button onclick="stopAgent(event)" class="btn btn-sm btn-error">üõë Stop</button>
                    <button onclick="sendControl('skip_step')" class="btn btn-sm btn-secondary">‚è≠Ô∏è Skip</button>
                    <button onclick="sendControl('reload_retry')" class="btn btn-sm btn-secondary">üîÑ Retry</button>
                </div>

                <div class="pause-control-container">
                    <div class="pause-control-left">
                        <div class="toggle-group" style="margin: 0; padding: 0;">
                            <div id="pauseNextToggle" class="toggle" onclick="togglePauseNext()"></div>
                            <label class="toggle-label" onclick="togglePauseNext()">Pause next</label>
                        </div>
                        <div class="vertical-divider"></div>
                    </div>
                    <div class="message-box">
                        <div id="pauseMessageBox">üí° Review before next action</div>
                    </div>
                </div>

                <div id="messageTicker" class="message-ticker">
                    <span class="ticker-icon">ü§ñ</span>
                    <span class="ticker-text">Ready for tasks</span>
                </div>

                <div class="speed-control">
                    <label>Agent Speed: <span id="speedValue">Human Pace</span></label>
                    <input type="range" id="speedSlider" min="0" max="10" value="5" oninput="updateSpeed(this.value)">
                    <div class="speed-labels">
                        <span class="speed-label-item">Instant</span>
                        <span class="speed-label-item">Fast</span>
                        <span class="speed-label-item">Normal</span>
                        <span class="speed-label-item">Slow</span>
                    </div>
                </div>

                <form onsubmit="sendMessage(event)" style="display: flex; gap: 8px; margin-top: 16px;">
                    <input type="text" id="messageText" autocomplete="off" placeholder="Enter your task..." style="flex: 1;" />
                    <button id="sendBtn" type="submit" class="btn" style="width: 120px;">‚ñ∂Ô∏è Run</button>
                    <button id="stopBtn" onclick="stopAgent(event)" type="button" class="btn btn-error" style="width: 100px;" disabled>‚èπÔ∏è Stop</button>
                </form>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar task-queue">
            <div class="sidebar-header">
                <h1><span>üìã</span> Task Queue</h1>
                <p>Manage Workflow</p>
            </div>

            <div class="sidebar-content">
                <div class="task-current">
                    <h4>Current Task</h4>
                    <div id="currentTaskDisplay" class="task-current-text">No active task</div>
                </div>

                <div class="task-groups-section">
                    <div class="task-groups-header">
                        <h4>üìÅ Saved Groups</h4>
                        <button onclick="showSaveGroupDialog()" class="btn btn-xs">üíæ Save</button>
                    </div>
                    <div id="taskGroupsList"></div>
                </div>

                <div style="margin-bottom: 12px;">
                    <div class="task-list-header">
                        <h4>Current Queue</h4>
                        <button onclick="clearAllTasks()" class="btn btn-xs btn-error">üóëÔ∏è Clear</button>
                    </div>
                </div>

                <div class="task-list" id="taskList"></div>

                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <input type="text" id="newTaskInput" placeholder="Add new task..." style="flex: 1;" />
                    <button onclick="addNewTask()" class="btn btn-sm">‚ûï</button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const ws = new WebSocket("ws://" + window.location.host + "/ws");
        let stepCount = 0;
        let tasks = [];
        let taskGroups = [];
        let historyItems = [];
        let startTime = null;
        let runtimeInterval = null;
        let totalActions = 0;
        let successfulActions = 0;
        let logs = [];
        let settings = { autoScroll: true, soundEnabled: false };

        function loadSavedData() {
            const saved = localStorage.getItem('taskGroups');
            if (saved) {
                taskGroups = JSON.parse(saved);
                renderTaskGroups();
            }
        }

        function saveTaskGroups() {
            localStorage.setItem('taskGroups', JSON.stringify(taskGroups));
        }

        ws.onopen = function() {
            console.log("Connected");
            loadSavedData();
            showNotification("Connected to agent", "success");
            addLog("info", "Connected to WebSocket");
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleMessage(data);
        };

        function handleMessage(data) {
            switch(data.type) {
                case 'plan_update':
                    updateTaskQueue(data.plan);
                    break;
                case 'log':
                    updateTicker('log', data.content);
                    addLog("info", data.content);
                    break;
                case 'step':
                    stepCount++;
                    totalActions++;
                    document.getElementById('stepCounter').textContent = stepCount + ' Steps';
                    updateTicker('step', `Step ${data.step}: ${data.thought || "Processing"}`);
                    if (data.screenshot) {
                        const img = "data:image/png;base64," + data.screenshot;
                        document.getElementById('liveImg').src = img;
                        addHistoryItem(stepCount, data.thought, img);
                    }
                    updateStats();
                    break;
                case 'stream':
                    document.getElementById('liveImg').src = "data:image/jpeg;base64," + data.image;
                    if (data.state) document.getElementById('monitorState').textContent = data.state;
                    if (data.goal) document.getElementById('monitorGoal').textContent = data.goal;
                    if (data.data) document.getElementById('monitorData').textContent = data.data;
                    break;
                case 'result':
                    updateTicker('success', data.content);
                    addLog("success", data.content);
                    resetControls();
                    successfulActions++;
                    updateStats();
                    showNotification("Task completed", "success");
                    break;
                case 'error':
                    updateTicker('error', data.content);
                    addLog("error", data.content);
                    resetControls();
                    showNotification("Task failed", "error");
                    break;
                case 'confirmation_required':
                    showConfirmationDialog(data);
                    break;
            }
        }

        function updateStats() {
            const rate = totalActions > 0 ? Math.round((successfulActions / totalActions) * 100) : 100;
            document.getElementById('successRate').textContent = rate + '%';
            
            if (startTime) {
                const elapsed = (Date.now() - startTime) / 1000 / 60;
                const apm = elapsed > 0 ? Math.round(totalActions / elapsed) : 0;
                document.getElementById('actionsPerMin').textContent = apm;
            }
            
            const memory = Math.round((historyItems.length * 50) + (tasks.length * 2));
            document.getElementById('memoryUsage').textContent = memory + ' KB';
        }

        function startRuntime() {
            startTime = Date.now();
            runtimeInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const min = Math.floor(elapsed / 60);
                const sec = elapsed % 60;
                document.getElementById('runtimeValue').textContent = 
                    min.toString().padStart(2, '0') + ':' + sec.toString().padStart(2, '0');
            }, 1000);
        }

        function stopRuntime() {
            if (runtimeInterval) {
                clearInterval(runtimeInterval);
                runtimeInterval = null;
            }
        }

        function updateTicker(type, text) {
            const ticker = document.getElementById('messageTicker');
            const icons = { 'step': 'üë£', 'log': 'üí¨', 'success': '‚úÖ', 'error': '‚ùå', 'info': 'ü§ñ' };
            const clean = text.replace(/<[^>]*>/g, '');
            const short = clean.length > 100 ? clean.substring(0, 100) + '...' : clean;
            ticker.innerHTML = `<span class="ticker-icon">${icons[type] || 'ü§ñ'}</span><span class="ticker-text">${short}</span>`;
        }

        function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById("messageText");
            const task = input.value.trim();
            
            if (!task) {
                showNotification("Please enter a task", "warning");
                return;
            }

            stepCount = 0;
            totalActions = 0;
            successfulActions = 0;
            document.getElementById('stepCounter').textContent = '0 Steps';
            document.getElementById('currentTaskDisplay').textContent = task;

            const agentType = document.getElementById("agentType").value;
            const settings = JSON.parse(document.getElementById("settingsJson").value);

            ws.send(JSON.stringify({
                action: "run",
                task: task,
                agent_type: agentType,
                ...settings
            }));

            document.getElementById('sendBtn').disabled = true;
            document.getElementById('sendBtn').innerHTML = '‚è≥ Running...';
            document.getElementById('stopBtn').disabled = false;
            input.value = '';
            
            startRuntime();
            historyItems = [];
        }

        function stopAgent(event) {
            event.preventDefault();
            ws.send(JSON.stringify({action: "stop"}));
            resetControls();
            stopRuntime();
            showNotification("Agent stopped", "warning");
        }

        function sendControl(command, value = null) {
            ws.send(JSON.stringify({ action: "control", command: command, value: value }));
        }

        function resetControls() {
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('sendBtn').innerHTML = '‚ñ∂Ô∏è Run';
            document.getElementById('stopBtn').disabled = true;
            stopRuntime();
        }

        function addHistoryItem(step, thought, img) {
            historyItems.unshift({ step, thought, imgData: img, timestamp: new Date() });
            if (historyItems.length > 20) historyItems = historyItems.slice(0, 20);
            renderHistory();
        }

        function renderHistory() {
            const panel = document.getElementById('historyPanel');
            panel.innerHTML = '';
            if (historyItems.length === 0) {
                panel.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No history</div>';
                return;
            }
            historyItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.onclick = () => document.getElementById('liveImg').src = item.imgData;
                div.innerHTML = `
                    <img src="${item.imgData}" class="history-thumbnail" />
                    <div>
                        <div class="history-step">Step ${item.step}</div>
                        <div class="history-thought">${item.thought || 'Processing...'}</div>
                    </div>
                `;
                panel.appendChild(div);
            });
        }

        function toggleHistory() {
            document.getElementById('historyPanel').classList.toggle('active');
        }

        function takeScreenshot() {
            const img = document.getElementById('liveImg');
            if (img.src) {
                const link = document.createElement('a');
                link.download = `screenshot-${Date.now()}.png`;
                link.href = img.src;
                link.click();
                showNotification("Screenshot saved", "success");
            }
        }

        function toggleZoom() {
            document.getElementById('monitorViewport').classList.toggle('zoomed');
        }

        function updateTaskQueue(plan) {
            if (!plan || plan.length === 0) return;
            tasks = plan.map((item, i) => ({
                id: i,
                text: `${i + 1}. ${item.step}`,
                status: item.status || 'pending',
                subtasks: []
            }));
            renderTasks();
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            if (tasks.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No tasks</div>';
                return;
            }
            tasks.forEach(task => {
                const div = createTaskElement(task);
                list.appendChild(div);
            });
        }

        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = `task-item ${task.status}`;
            if (task.status === 'in_progress') div.classList.add('active');
            
            const icons = { 'pending': '‚è≥', 'in_progress': '‚ñ∂Ô∏è', 'completed': '‚úÖ', 'failed': '‚ùå' };
            
            const mainRow = document.createElement('div');
            mainRow.className = 'task-main-row';
            mainRow.innerHTML = `
                <span class="task-icon">${icons[task.status] || '‚è≥'}</span>
                <div class="task-content">
                    <div class="task-text">${task.text}</div>
                </div>
                <div class="task-actions">
                    <button class="btn btn-xs btn-error" onclick="deleteTask(event, ${task.id})">‚úï</button>
                </div>
            `;
            div.appendChild(mainRow);
            return div;
        }

        function addNewTask() {
            const input = document.getElementById('newTaskInput');
            const text = input.value.trim();
            if (!text) return;
            
            tasks.push({
                id: tasks.length,
                text: text,
                status: 'pending',
                subtasks: []
            });
            renderTasks();
            sendControl('add_task', text);
            input.value = '';
            showNotification("Task added", "success");
        }

        function deleteTask(event, taskId) {
            event.stopPropagation();
            tasks = tasks.filter(t => t.id !== taskId);
            renderTasks();
        }

        function clearAllTasks() {
            if (confirm("Clear all tasks?")) {
                tasks = [];
                renderTasks();
                showNotification("Queue cleared", "info");
            }
        }

        function showSaveGroupDialog() {
            if (tasks.length === 0) {
                showNotification("No tasks to save", "warning");
                return;
            }
            document.getElementById('saveGroupOverlay').classList.add('active');
        }

        document.getElementById('saveGroupBtn').onclick = function() {
            const name = document.getElementById('groupNameInput').value.trim();
            if (!name) {
                showNotification("Enter a group name", "warning");
                return;
            }
            taskGroups.push({
                id: Date.now(),
                name: name,
                description: document.getElementById('groupDescInput').value.trim(),
                tasks: JSON.parse(JSON.stringify(tasks))
            });
            saveTaskGroups();
            renderTaskGroups();
            document.getElementById('saveGroupOverlay').classList.remove('active');
            document.getElementById('groupNameInput').value = '';
            document.getElementById('groupDescInput').value = '';
            showNotification(`Group "${name}" saved`, "success");
        };

        document.getElementById('cancelGroupBtn').onclick = function() {
            document.getElementById('saveGroupOverlay').classList.remove('active');
        };

        function renderTaskGroups() {
            const container = document.getElementById('taskGroupsList');
            container.innerHTML = '';
            if (taskGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 12px;">No saved groups</div>';
                return;
            }
            taskGroups.forEach(group => {
                const div = document.createElement('div');
                div.className = 'task-group-item';
                div.innerHTML = `
                    <div>
                        <div class="task-group-name">${group.name} <span class="task-group-count">(${group.tasks.length})</span></div>
                    </div>
                    <div class="task-group-actions">
                        <button class="btn btn-xs" onclick="loadTaskGroup(${group.id})">üì•</button>
                        <button class="btn btn-xs btn-error" onclick="deleteTaskGroup(event, ${group.id})">‚úï</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function loadTaskGroup(groupId) {
            const group = taskGroups.find(g => g.id === groupId);
            if (group) {
                tasks = JSON.parse(JSON.stringify(group.tasks));
                renderTasks();
                showNotification(`Loaded: ${group.name}`, "success");
            }
        }

        function deleteTaskGroup(event, groupId) {
            event.stopPropagation();
            if (confirm("Delete this group?")) {
                taskGroups = taskGroups.filter(g => g.id !== groupId);
                saveTaskGroups();
                renderTaskGroups();
                showNotification("Group deleted", "info");
            }
        }

        function showConfirmationDialog(data) {
            document.getElementById('dialogIntel').textContent = data.intel || 'N/A';
            document.getElementById('dialogNextTask').textContent = data.next_task || 'N/A';
            document.getElementById('confirmationOverlay').classList.add('active');
        }

        document.getElementById('confirmYesBtn').onclick = function() {
            ws.send(JSON.stringify({
                action: "confirmation",
                response: "yes",
                custom_task: document.getElementById('customTaskInput').value
            }));
            document.getElementById('confirmationOverlay').classList.remove('active');
            document.getElementById('customTaskInput').value = '';
        };

        document.getElementById('confirmNoBtn').onclick = function() {
            ws.send(JSON.stringify({ action: "confirmation", response: "no" }));
            document.getElementById('confirmationOverlay').classList.remove('active');
        };

        function toggleVision() {
            document.getElementById('visionToggle').classList.toggle('active');
        }

        function toggleSound() {
            const toggle = document.getElementById('soundToggle');
            toggle.classList.toggle('active');
            settings.soundEnabled = toggle.classList.contains('active');
        }

        function togglePauseNext() {
            const toggle = document.getElementById('pauseNextToggle');
            toggle.classList.toggle('active');
            const active = toggle.classList.contains('active');
            const box = document.getElementById('pauseMessageBox');
            box.innerHTML = active ? '‚è∏Ô∏è Agent will pause after next step' : 'üí° Review before next action';
            sendControl('pause_on_next_step', active);
        }

        function updateSpeed(value) {
            const speeds = ['Instant', 'Very Fast', 'Fast', 'Quick', 'Moderate', 'Human Pace', 'Careful', 'Deliberate', 'Slow', 'Very Slow', 'Ultra Slow'];
            document.getElementById('speedValue').textContent = speeds[value];
            sendControl('update_speed', value);
        }

        function updateTemp(value) {
            document.getElementById('tempValue').textContent = (value / 10).toFixed(1);
        }

        function updateLLMSettings() {
            const provider = document.getElementById('llmProvider').value;
            // Add provider-specific logic here
        }

        function switchSidebarTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function toggleCard(header) {
            header.parentElement.classList.toggle('collapsed');
        }

        function showPresetsModal() {
            document.getElementById('presetsOverlay').classList.add('active');
        }

        function closePresetsModal() {
            document.getElementById('presetsOverlay').classList.remove('active');
        }

        function showShortcutsModal() {
            document.getElementById('shortcutsOverlay').classList.add('active');
        }

        function closeShortcutsModal() {
            document.getElementById('shortcutsOverlay').classList.remove('active');
        }

        function loadPreset(type) {
            const presets = {
                research: { agentType: 'deep_research', maxSteps: 1000 },
                testing: { agentType: 'browser', maxSteps: 500 },
                scraping: { agentType: 'browser', maxSteps: 300 },
                automation: { agentType: 'browser', maxSteps: 500 }
            };
            if (presets[type]) {
                document.getElementById('agentType').value = presets[type].agentType;
                document.getElementById('maxSteps').value = presets[type].maxSteps;
                showNotification(`Loaded ${type} preset`, "success");
            }
            closePresetsModal();
        }

        function exportConfig() {
            const config = {
                settings: document.getElementById('settingsJson').value,
                agentType: document.getElementById('agentType').value,
                maxSteps: document.getElementById('maxSteps').value
            };
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'agent-config.json';
            a.click();
            showNotification("Config exported", "success");
        }

        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const config = JSON.parse(event.target.result);
                        if (config.settings) document.getElementById('settingsJson').value = config.settings;
                        if (config.agentType) document.getElementById('agentType').value = config.agentType;
                        if (config.maxSteps) document.getElementById('maxSteps').value = config.maxSteps;
                        showNotification("Config imported", "success");
                    } catch (err) {
                        showNotification("Invalid config file", "error");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function addLog(type, message) {
            const time = new Date().toLocaleTimeString();
            logs.unshift({ type, message, time });
            if (logs.length > 100) logs = logs.slice(0, 100);
            renderLogs();
        }

        function renderLogs() {
            const viewer = document.getElementById('logViewer');
            viewer.innerHTML = '';
            if (logs.length === 0) {
                viewer.innerHTML = '<div style="text-align: center; color: var(--text-muted);">No logs</div>';
                return;
            }
            logs.forEach(log => {
                const div = document.createElement('div');
                div.className = `log-entry ${log.type}`;
                div.innerHTML = `<span class="log-time">${log.time}</span><span class="log-message">${log.message}</span>`;
                viewer.appendChild(div);
            });
        }

        function clearLogs() {
            logs = [];
            renderLogs();
            showNotification("Logs cleared", "info");
        }

        function showNotification(message, type = "info") {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            
            const colors = {
                success: 'var(--success)',
                error: 'var(--error)',
                warning: 'var(--warning)',
                info: 'var(--accent-primary)'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 4px; height: 24px; background: ${colors[type]}; border-radius: 2px;"></div>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('sendBtn').click();
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                stopAgent(e);
            } else if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                togglePauseNext();
            } else if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                toggleHistory();
            } else if (e.key === '?' && !e.ctrlKey) {
                e.preventDefault();
                showShortcutsModal();
            }
        });

        console.log("Browser Agent Pro Enhanced v2.5 initialized");
    </script>
</body>
</html>